# SAAO/SALT Data Archive docker compose

The SAAO/SALT Data Archive is powered by docker and is executed using docker compose.

## How to run the SAAO/SALT Data Archive

First, you must make sure that the following tools are  installed:

1. [Docker](https://www.docker.com/) and
2. [Docker compose](https://docs.docker.com/compose/)

Clone the following repositories to a location of your choice.


```sh
git clone https://github.com/saltastroops/data-archive-docker-compose.git &&
git clone https://github.com/saltastroops/data-archive-backend.git data-archive-backend &&
git clone https://github.com/saltastroops/data-archive-frontend.git
```

or using ssh

```sh
git clone git@github.com:saltastroops/data-archive-docker-compose.git &&
git clone git@github.com:saltastroops/data-archive-backend.git data-archive-backend &&
git clone git@github.com:saltastroops/data-archive-frontend.git
```

The docker compose requires the following environment variables. 

Variable | Description | Example
---- | ---- | ----
DATA_ARCHIVE_BACKEND_BASE_DIR | The location of the data archive backend | /path/to/data-archive-backend
DATA_ARCHIVE_BACKEND_PORT | Port on which the data archive backend should be listening | 4001
DATA_ARCHIVE_FRONTEND_BASE_DIR | The location of the data archive frontend | /path/to/data-archive-backend
DATA_ARCHIVE_FRONTEND_BUILD_BASE_DIR | The location of the data archive frontend build directory| /path/to/data-archive-backend/build
DATA_ARCHIVE_FRONTEND_PORT | Port on which the data archive frontend should be listening | 3000
NGINX_PORT | The free port on the host to map with the nginx image port  | 8000
POSTGRES_IMAGE_PASSWORD | The postgres image password | secret
POSTGRES_PORT | The free port on the host to map with the postgres image port  | 5431


Execute the following command to run the data archive,

## On local host

```sh
docker-compose up -d
```

to stop the data archive containers execute the following command

```sh
docker-compose down
```

## On development and production servers

```sh
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

nginx will fail and that is beacuse it requires the certificates for https.
See [here](https://medium.com/@pentacent/nginx-and-lets-encrypt-with-docker-in-less-than-5-minutes-b4b8a60d3a71) for details

To enable https, execute the following command

```sh
sudo ./init-letsencrypt.sh
```

A dummy certificate will be generated by means of certbox, this will trick nginx to think it has the certificates.

Re-run the docker-compose to activate the real certificate.

```sh
docker-compose -f docker-compose.yml -f docker-compose.prod.yml restart
```

To stop the data archive containers, execute the following command

```sh
docker-compose -f docker-compose.yml -f docker-compose.prod.yml down
```
